name: '[Template] Get PR Info'
on:
  workflow_call:
    inputs:
      pull_request_number:
        description: "Pull request number"
        required: true
        type: string
    outputs:
      base_sha:
        description: "Base commit SHA"
        value: ${{ jobs.extract.outputs.base_sha }}
      head_sha:
        description: "Head commit SHA"
        value: ${{ jobs.extract.outputs.head_sha }}
      head_ref:
        description: "Head Ref"
        value: ${{ jobs.extract.outputs.head_ref }}
      report_id:
        description: "Extracted report ID from branch name"
        value: ${{ jobs.extract.outputs.report_id }}
      report_version:
        description: "Extracted report version from branch name"
        value: ${{ jobs.extract.outputs.report_version }}
      dispatched_at:
        description: "Extracted dispatched_at value from branch name"
        value: ${{ jobs.extract.outputs.dispatched_at }}

jobs:
  extract:
    runs-on: ubuntu-latest
    outputs:
      base_sha: ${{ steps.pr.outputs.base_sha }}
      head_sha: ${{ steps.pr.outputs.head_sha }}
      head_ref: ${{ steps.pr.outputs.head_ref }}
      report_id: ${{ steps.pr.outputs.report_id }}
      report_version: ${{ steps.pr.outputs.report_version }}
      dispatched_at: ${{ steps.pr.outputs.dispatched_at }}
    steps:
      - name: Get pull request
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pull_number = ${{ inputs.pull_request_number }};
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pull_number
            });
            const headRef = pr.head.ref;
            const match = headRef.match(/^(?:test\/)?([A-Za-z0-9]+)-(v\d+)-([0-9_]+)$/);
            if (!match) {
              core.setFailed(`head_ref "${headRef}" doesn't match expected format {report_id}-{report_version}-{dispatched_at}`);
            }
            const [, reportId, reportVersion, dispatchedAt] = match;
            const outputs = {
              base_sha: pr.base.sha,
              head_sha: pr.head.sha,
              head_ref: headRef,
              report_id: reportId,
              report_version: reportVersion,
              dispatched_at: dispatchedAt
            };
            for (const [key, value] of Object.entries(outputs)) {
              core.setOutput(key, value);
            }
            console.log('Outputs:', JSON.stringify(outputs, null, 2));
